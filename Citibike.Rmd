---
title: "Citibike"
author: "Victor J"
date: "11/30/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    codefolding: hide
    
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
```
```{r}
library(tidyverse)
library(gganimate)
library(geosphere)
library(lubridate)
library(ggplot2)
library(dplyr)
library(knitr)
```


## Data frame setup 
### Data Cleaning 
```{r}
#Start New RMD File for Analysis
#Reading the new csv file 
citisample <- read.csv("citibike.csv")
citisample$X <- NULL
citisample$start.station.id <- as.factor(citisample$start.station.id)
citisample$end.station.id <- as.factor(citisample$end.station.id)
citisample$bikeid <- as.factor(citisample$bikeid)
citisample$usertype <- as.factor(citisample$usertype)
citisample$gender <- as.factor(citisample$gender)
# Fix gender
citisample$gender <- ifelse(citisample$gender == 1, "male", ifelse(citisample$gender == 2, "female", "unknown"))
citisample$gender <- as.factor(citisample$gender)
# Create a column for approximate age
citisample$age <- 2021 - citisample$birth.year
```

### Data Cleaning Continued
```{r}
citisample$starttime <- as.POSIXct(strptime(citisample$starttime, "%Y-%m-%d %H:%M:%S"))
citisample$stoptime <- as.POSIXct(strptime(citisample$stoptime, "%Y-%m-%d %H:%M:%S"))

citisample$starthour <- hour(citisample$starttime)
citisample$day <- as.Date(citisample$starttime)

citisample$month <- as.factor(month(citisample$day))

citisample$numWeekday <- wday(citisample$starttime)
citisample$dayid <- as.factor(ifelse(citisample$numWeekday < 6, "Weekday", "Weekend"))
citisample$weekNum <- as.numeric(strftime(citisample$starttime, format = "%V"))

citisample$distmeters <- distHaversine(cbind(citisample$start.station.latitude, citisample$start.station.longitude), cbind(citisample$end.station.latitude, citisample$end.station.longitude))

citisample$speed <- citisample$distmeters / citisample$tripduration
str(citisample)
```
### Merging NYC Weather Data
```{r}
#Merging Datasets
weather <- read.csv("NYCWeather2019.csv")
weather$STATION <- NULL
weather$NAME <- NULL
weather$DATE <- as.Date(weather$DATE, format= "%m/%d/%Y")
weather$TAVG <- (weather$TMAX + weather$TMIN)/2

citiday <- citisample %>%
  group_by(day, gender, dayid) %>%
  summarize(count = n(),
            dist = mean(distmeters, na.rm = TRUE),
            dur = mean(tripduration, na.rm = TRUE),
            speed = dist/dur)

combined_gender <- merge(citiday, weather, by.x = "day", by.y = "DATE")
```
## Citi Bike Data Context 
```{r}
ggplot(citisample, aes(x=month)) + geom_bar() +labs( title = "Amount of Rides in 2019 per month")
```

```{r}
ggplot(citisample, aes(x=month, fill = gender)) + geom_bar(position=position_dodge()) +labs( title = "Amount of Rides in 2019 by gender")
```

```{r}
ggplot(citisample, aes(x=usertype)) + geom_bar(position=position_dodge()) +labs( title = "Subscriber v. Customer amount of rides in 2019")
```



## Assymetric Traffic 
```{r}
citisample$route <- paste(citisample$start.station.name,citisample$end.station.name,sep=" -> ")

citisample %>% 
  group_by(route) %>% 
  summarize(count=n()) %>% 
  arrange(desc(count)) %>% 
  top_n(n=10) %>% kable(format="markdown")
```

## Bike Usage 
### BikeID
```{r}
citisample %>%
  group_by(bikeid) %>%
  summarize(count=n()) %>%
  arrange(desc(count)) %>%
  top_n(n=10) %>% kable(format="markdown")
```




## Weather 

```{r}
ggplot(combined_gender, aes(x = TAVG, y = dist)) + geom_point(size = 2, alpha = 0.5, color = "yellowgreen") + geom_smooth(color = "darkgreen") + ylim(0,3000) 
```

### Does the ridership speed differ between months? 
```{r}
citisample %>%
  group_by(month) %>%
  summarize(count = n(),
            dist = mean(distmeters, na.rm = TRUE),
            dur = mean(tripduration, na.rm = TRUE),
            speed = dist/dur) %>%
  ggplot(aes(x=month, y = dist, fill = count)) + geom_col() +labs(y="Distance", title = "Avg Distance each Month" )
```
